---
author: [[huggingface.co]]
title: "Extending Transformer Layers as Painters to DiT&#39;s"
date: 2024-10-08
tags: 
- articles
- literature-note
---
![rw-book-cover](https://cdn-thumbnails.huggingface.co/social-thumbnails/blog/NagaSaiAbhinay/transformer-layers-as-painters-dit.png)

## Metadata
- Author: [[huggingface.co]]
- Full Title: Extending Transformer Layers as Painters to DiT's
- URL: https://huggingface.co/blog/NagaSaiAbhinay/transformer-layers-as-painters-dit

## Highlights
- The motivation for this experiment comes from "Transformer layers as Painters"[[1]](https://huggingface.co/blog/NagaSaiAbhinay/transformer-layers-as-painters-dit#ref1). by [Sakana AI](https://huggingface.co/SakanaAI) and [Emergence AI](https://huggingface.co/EmergenceAI) who suggest the existence of a common representation space among the layers of an LLM because of the residual connections. ([View Highlight](https://read.readwise.io/read/01j9pnbjmt181xy8kywa0b8j4c))
- Transformer layers or MM-DiT layers as referred to here have two streams for dealing with text embeddings and image embeddings seperately while also having a joint attention mechanism. ([View Highlight](https://read.readwise.io/read/01j9pnc30vrgvdz05qveh422db))
- Single layers or Joint layers deal with encoder embeddings and image embeddings together a.k.a single flow blocks in Flux arch listed above. ([View Highlight](https://read.readwise.io/read/01j9pnc5rzq5jv6zdh9spzh2p5))
- Grouping of the layers based on cosine similarity is done into first layers, middle layers and last layers as in the paper. ([View Highlight](https://read.readwise.io/read/01j9pnccw9mbd414v97bwvh861))
- The following layer execution strategies are used for the experiment: [![image/png](https://cdn-uploads.huggingface.co/production/uploads/63158cbb8be84e1ab4162510/l81R2mdOUI_psN7mOW-AX.png)](https://cdn-uploads.huggingface.co/production/uploads/63158cbb8be84e1ab4162510/l81R2mdOUI_psN7mOW-AX.png) ([View Highlight](https://read.readwise.io/read/01j9pncjcjfxfbsw0shehbk8jk))
- Flux shows the most prominent grouping (based on activation cosine similarity) of layers indicating the possibility of a common representation space followed by AuraFlow. But all 3 models do show grouping indicating a common representation space. ([View Highlight](https://read.readwise.io/read/01j9pncv5hxrepe0kgks6q0mv7))
- The layers before and after a group of layers seem to act as 'translation' layers, converting the model representation from one space to another. This is evidenced by the fact that removing preceding layers is catastrophic. ([View Highlight](https://read.readwise.io/read/01j9pncz3xxbxz20sytz118qh6))
- Skipping some layers from a group of layers degrades image quality the least compared to other methods. This is in line with the finding of the paper. ([View Highlight](https://read.readwise.io/read/01j9pnd6cv9c6ve8ebm5cpsjqb))
- Repeating the same layer from a group is the worst (apart from removing the so called 'translation' layers which don't belong to the group anyway) ([View Highlight](https://read.readwise.io/read/01j9pnd9c4b4mx52smkbs80222))
- Repeatedly executing the layers in parallel and averaging their outputs is not catastrophic for layers that give prompt adherence but catastrophic for layers that deal with aesthetic quality. Same with reversing the middle layers. ([View Highlight](https://read.readwise.io/read/01j9pndb02fyq8k54x1a9cpmqv))
- Flux architecure has two different transformer blocks. The one referred to here as transformer block/layer is a MMDiT block which has two streams, one for encoder hidden states and one for hidden states. The single transformer block/layer is single stream which acts on hidden states. See the architecture[[3]](https://huggingface.co/blog/NagaSaiAbhinay/transformer-layers-as-painters-dit#ref3) ([View Highlight](https://read.readwise.io/read/01j9pndrkmgxbdfm6h54cbf7c8))
- • Skipping the first MM-DiT block is not catastrophic but shows the role it plays in converting (translation) the prompt to the representation space. And the last layer converts (translation) it to the space of the single layers. [![image/png](https://cdn-uploads.huggingface.co/production/uploads/63158cbb8be84e1ab4162510/-3ys9nvv1YYH9s1CrAdxs.png)](https://cdn-uploads.huggingface.co/production/uploads/63158cbb8be84e1ab4162510/-3ys9nvv1YYH9s1CrAdxs.png)
  • Skipping MM-DiT layers from the middle group affects the finer details of the image while retaining the broad concepts of the prompt. (pink glasses are present but on dog. Robot is no longer made of felt etc...) ([View Highlight](https://read.readwise.io/read/01j9pnf3kat0f8ggmcgf95actd))
- Skipping single layers affects the visual quality. There are two distinct middle layer groupings in the Flux single layers. The first seems to be responsible for building the structural layout and broad details whereas the following group deals with finer details. [![image/png](https://cdn-uploads.huggingface.co/production/uploads/63158cbb8be84e1ab4162510/inT59pxDSjmUqfZfEaAvM.png)](https://cdn-uploads.huggingface.co/production/uploads/63158cbb8be84e1ab4162510/inT59pxDSjmUqfZfEaAvM.png) ([View Highlight](https://read.readwise.io/read/01j9pnfeqpq8fxr3rfhmjgp2jr))
- Skipping single layers preceding the middle group affects the aesthetics and results in visual hallucinations: (multiple instances of same subject. eg: multiple parrots) and missing details (bridge) which can indicate incorrect 'translation' of the prompt to details. [![image/png](https://cdn-uploads.huggingface.co/production/uploads/63158cbb8be84e1ab4162510/WUubROzUdffXqSqSb_Xfj.png)](https://cdn-uploads.huggingface.co/production/uploads/63158cbb8be84e1ab4162510/WUubROzUdffXqSqSb_Xfj.png) ([View Highlight](https://read.readwise.io/read/01j9png0dt5t2fzkt2g7pdge3m))
- Repeating the same layer multiple times is catastrophic. Paper theorizes that this is because it pushes the data out of distribution from what the model has trained to handle. [![image/png](https://cdn-uploads.huggingface.co/production/uploads/63158cbb8be84e1ab4162510/KCydWN15G7rivnL5mMXhV.png)](https://cdn-uploads.huggingface.co/production/uploads/63158cbb8be84e1ab4162510/KCydWN15G7rivnL5mMXhV.png) ([View Highlight](https://read.readwise.io/read/01j9pngcrzyynxyrhqej3dtkqk))
- Reversing MM-DiT layers retains some concepts from the prompt but details are completely lost. Reversing single layers is catastrophic. [![image/png](https://cdn-uploads.huggingface.co/production/uploads/63158cbb8be84e1ab4162510/jguS_PaCtgXiKKfyPeJv9.png)](https://cdn-uploads.huggingface.co/production/uploads/63158cbb8be84e1ab4162510/jguS_PaCtgXiKKfyPeJv9.png) ([View Highlight](https://read.readwise.io/read/01j9pnghwk67pbf3ds7adkackf))
- Executing the middle layers in parallel and averaging their outputs is catastrophic. [![image/png](https://cdn-uploads.huggingface.co/production/uploads/63158cbb8be84e1ab4162510/FdYuR_DoUDv7aphMkyGe3.png)](https://cdn-uploads.huggingface.co/production/uploads/63158cbb8be84e1ab4162510/FdYuR_DoUDv7aphMkyGe3.png) ([View Highlight](https://read.readwise.io/read/01j9pngqahd9m7zan201sawcrp))
- Based on this distinction of layers and the roles they seemingly play, a natural question is how would applying LoRA to specific layers affect the training and image generation during inference ?
  Edit: See [https://x.com/__TheBen/status/1829554120270987740](https://x.com/__TheBen/status/1829554120270987740) It actually makes a difference! You don't need to train LoRA's on all layers. ([View Highlight](https://read.readwise.io/read/01j9pnh8ztmz43h4qnvsw13bg5))
