---
author: [[trychroma.com]]
title: "Embedding Adapters"
date: 2024-06-01
tags: 
- articles
- literature-note
---
![rw-book-cover](http://research.trychroma.com/img/embedding_adapters/card.png?v1)

## Metadata
- Author: [[trychroma.com]]
- Full Title: Embedding Adapters
- URL: https://research.trychroma.com/embedding-adapters

## Highlights
- [Suvansh Sanjeev](https://x.com/SuvanshSanjeev)Researcher in Residence - Chroma
  [Anton Troynikov](https://x.com/atroyn)Cofounder - Chroma
  Retrieval accuracy is an important determinant of AI application performance. However, many approaches to improving retrieval accuracy require large labeled corpora, which are often not available to application developers. Additionally, many of these approaches require re-computing the entire set of embeddings.
  In this work we demonstrate that applying a linear transform, trained from relatively few labeled datapoints, to just the query embedding, produces a significant improvement in retrieval accuracy across many domains, including across languages.
  ![](https://research.trychroma.com/img/embedding_adapters/header_plot.png)
  ![](https://research.trychroma.com/img/embedding_adapters/hero_ndcg.png)
  Normalized discounted cumulative gain (NDCG), CQADupstackEnglishRetrieval. A simple query-only linear adapter produces an up to 70% improvement. ([View Highlight](https://read.readwise.io/read/01hz5geqfxz0t383px552gw3r6))
- The idea of applying a linear transform to embeddings to improve retrieval performance is not new, and has been explored in various forms. The purpose of this technical report is to more rigorously evaluate the effectiveness of this approach in practical retrieval applications.
  ![](https://research.trychroma.com/img/embedding_adapters/adapters_explainer.png) ([View Highlight](https://read.readwise.io/read/01hz5gf9hp2faz50qkshctztrx))
- The basic concept is fairly straightforward. Given a set of query embeddings, and a set of relevant and irrelevant document embeddings for each query, we can learn a transform which squeezes and rotates the vector space, mapping them to a new space where the relevant documents are closer to the query. We refer to this transform as an 'adapter', since we apply it after the output of the embedding model itself. ([View Highlight](https://read.readwise.io/read/01hz5gfdb60sx5vfm4sx0kc63g))
- The simplest such adapter is a linear transform, which can be implemented efficiently as a matrix multiplication. In this work we find that training an adapter applied to **just the query embedding**, from relatively few labeled query-document pairs (as few as 1,500), produces an improvement in retrieval accuracy over the pre-trained embedding model alone of **up to 70%**. These labels can be collected from human feedback, for example from application usage. Further, we show that negative examples generated as random samples from documents not labeled as relevant to a particular query, is sufficient to achieve this improvement, considerably reducing labeling cost. ([View Highlight](https://read.readwise.io/read/01hz5gfm3d6qn0tbbk4jej3xzd))
- While we are confident that this simple approach is likely to improve retrieval accuracy in many practical settings, particularly in retreival for AI applications involving relatively small (~10,000) collections of embeddings, our analysis is not exhaustive. We show that the magnitude of gains varies significantly, depending on the training data. Additionally, we only attempt the simplest approach of training each parameter of the linear adapter independently, rather than constraining the resulting transform to a particular rank or group. This is left to future work. ([View Highlight](https://read.readwise.io/read/01hz5gg26qtc09575xeyrmrbke))
- Learning is compression. By detecting patterns in the world, we can represent complex information in a more compact and efficient manner. This idea is at the core of representational learning, which focuses on learning representations of data that capture its underlying structure and semantics. In particular, embeddings seek to compress high-dimensional data, such as words or images, into dense, low-dimensional vectors. These embedded representations are learned through neural networks, optimized to capture the essential features and relationships within the data. ([View Highlight](https://read.readwise.io/read/01hz5gggwx043tpjraeq34httc))
- Once embeddings have been learned, they can be adapted and fine-tuned for various downstream tasks, allowing for more specialized and efficient performance. This adaptability is one of the key strengths of embeddings, as they provide a foundation for transfer learning, where knowledge gained from one task can be applied to another. By reducing the dimensionality of the data and warm-starting with useful representations, embeddings not only make downstream learning processes more computationally tractable, but also enable the discovery of hidden connections and similarities that might be obscured in the original representation. By leveraging pre-trained embeddings and fine-tuning them with task-specific data, we can create models that are more accurate and require less training time compared to learning from scratch. This approach has been particularly successful in natural language processing tasks, such as sentiment analysis, named entity recognition, and machine translation, where pre-trained word embeddings have significantly improved performance. ([View Highlight](https://read.readwise.io/read/01hz5ggqhka9grxdmwt4ebsvh0))
- One promising application of embeddings is in retrieval-augmented generation (RAG), a framework that combines the strengths of retrieval-based and generative models. In this approach, embeddings are used to retrieve relevant information from a large knowledge base, which is then used to augment the input to an LLM. By providing the generative model with additional context and information, retrieval-augmented generation can produce more accurate, informative, and contextually appropriate responses. The retrieval step in this framework relies heavily on the quality of the embeddings used to represent the query and the knowledge base documents, as the effectiveness of the retrieval directly impacts the performance of the generative model. ([View Highlight](https://read.readwise.io/read/01hz5gh65x88jjqweq9jy7jbmx))
- In recent years, there has been a growing interest in using human feedback to align and improve machine learning systems with user intent. One promising but under-explored application of this approach is in RAG. By incorporating human feedback into the retrieval process, we can learn to prioritize and select the most relevant information based on user preferences and needs. This personalization of embeddings has the potential to greatly improve the quality and usefulness of generated content, making it more tailored to individual users. In this work, we will explore cost-effective and readily deployable techniques for using annotated positives to personalize retrieval-augmented generation systems by creating more effective embeddings. ([View Highlight](https://read.readwise.io/read/01hz5gkfctb7c4z56f752w3yyg))
- • Query-only linear adapters. In leaving the document embeddings unchanged, these adapters lower the cost of retrieval adaptation by obviating the need to re-embed all of the documents by applying the adapter to all of the documents in the RAG system’s corpus. Instead, the adaptation occurs on the query alone, which is a negligible overhead at query time.
  • Experiments comparing various types of linear adapters to finetuned embeddings. We find that the query-only linear adapters are competitive with the more computationally onerous linear adapters as well as finetuning.
  • The codebase for our adapters, including scripts used to run retrieval adaptation experiments and hyperparameter sweeps on various datasets, and LaunchKit, the lightweight library we use to launch them. LaunchKit is stripped out from RLKit from the Robotics and AI Lab at UC Berkeley. ([View Highlight](https://read.readwise.io/read/01hz5gm25m0dbyqwzj2jvq74fm))
- Linear adapters on embeddings have been explored before. The [Customizing Embeddings](https://cookbook.openai.com/examples/customizing_embeddings) Jupyter Notebook by Openai demonstrates the process of training what we term here the joint linear adapter, where both items being compared via the embeddings are mapped using the same adapter. They also explore random negative sampling for synthetic negatives, which we employ and ablate in this work. ([View Highlight](https://read.readwise.io/read/01hz5gmbeyhstz7wfn5xbmwx5j))
- In their paper [“Improving Text Embeddings with Large Language Models”](https://arxiv.org/abs/2401.00368), Wang et al. demonstrate the use of LLM-generated synthetic documents to finetune embeddings for retrieval tasks and evaluate on the Massive Text Embedding Benchmark (MTEB) retrieval benchmarks. ([View Highlight](https://read.readwise.io/read/01hz5gmg3dsggrenhvgncr8ntg))
- The [SentenceTransformers](https://sbert.net/) package provides pre-trained embedding models and a framework to finetune them for downstream tasks. They explore various related approaches, notably including Augmented SBERT, which uses cross-encoders (reranking models) to augment and annotate data for use in training bi-encoders (embedding models for sentence pair comparison tasks). Rerankers are a high-performance, high-cost approach to domain-specific adaptation. ([View Highlight](https://read.readwise.io/read/01hz5gmhhtkvpfmbky3zvnsv8a))
- Over the course of this project, we investigated the following approaches to adapting vector embeddings to annotated query-document pairs to improve retrieval performance:
  • Linear adapters on the embeddings
  • Joint: both queries and documents are mapped with the same linear adapter.
  • Query-only: document embeddings remain untouched, but a linear adapter is trained to map the query embeddings.
  • Query-first: we learn a joint linear adapter, warm-starting with the query-only adapter weights
  • Separate: queries and documents are mapped with separate linear adapters.
  • Fine-tuned embedding models ([View Highlight](https://read.readwise.io/read/01hz5gn596cfhcpqaj8qbn868e))
- We use the pre-trained all-MiniLM-L6-v2 embedding model from Sentence-Transformers as the baseline model in our experiments, atop which we train adapters and perform fine-tuning. The Massive Text Embedding Benchmark (MTEB) consists of benchmarks for several embedding tasks, including retrieval. We leverage the existing MTEB infrastructure for benchmark evaluation in our experiments, tracking the following retrieval performance metrics:
  • Mean average precision (MAP)
  • Mean reciprocal rank (MRR)
  • Normalized discounted cumulative gain (NDCG)
  • Precision
  • Recall ([View Highlight](https://read.readwise.io/read/01hz5gnhjbkw0xrr2jp24yvxsx))
- ![](https://research.trychroma.com/img/embedding_adapters/cqa_dupstack_ndcg.png)
  On [CQADupstackEnglishRetrieval](http://nlp.cis.unimelb.edu.au/resources/cqadupstack/), we find that the query-only linear adapter performs the best, even surpassing the performance of finetuning. ([View Highlight](https://read.readwise.io/read/01hz5gqs2sk6yyb0sv2q5jzq46))
- The embedding model we use, all-MiniLM-L6-v2, is trained on English text and consequently performs relatively poorly on [SpanishPassageRetrievalS2S](https://mklab.iti.gr/results/spanish-passage-retrieval-dataset/), a Spanish language benchmark.
  ![](https://research.trychroma.com/img/embedding_adapters/spanishS2S_map.png)
  ![](https://research.trychroma.com/img/embedding_adapters/spanishS2S_ndcg.png) ([View Highlight](https://read.readwise.io/read/01hz5gr09htf9gqq7c4jnd99bg))
- **However, we see that a linear adapter is sufficient to yield respectable performance on the benchmark**. The fine-tuned approach works best, with the linear adapters not far behind. Once again, the query-only linear adapter is competitive with the other approaches. We suspect that due to similarities in the structure of the two languages, their learned representations have a similar structure, up to a linear transformation, which the linear adapter can learn. ([View Highlight](https://read.readwise.io/read/01hz5gr4bz25r74vdhwcf4zaxg))
- Negative Sampling
  We present two types of linear adapters on two different benchmarks to demonstrate the effect of negative sampling. The remaining graphs can be found in [the repository](https://github.com/suvansh/ChromaAdaptEmbed/tree/main/images/negative_ablation/).
  ![](https://research.trychroma.com/img/embedding_adapters/cqa_negative_map.png)
  ![](https://research.trychroma.com/img/embedding_adapters/cqa_negative_ndcg.png) ([View Highlight](https://read.readwise.io/read/01hz5grpyhyt7x6y546mb838wj))
- ![](https://research.trychroma.com/img/embedding_adapters/quora_data_ndcg.png)
  **QuoraRetrieval** – Linear (Query-Only)
  We can see that breakeven is about 20-35% of the data. The subsets we trained on were randomly sampled, so it is likely that greater data efficiency can be obtained through selective sampling. Additionally, noting the scale of the y-axes, we note that the saturation curve looks vastly different between the two benchmarks used here. For training embedding adapters, properties of the particular dataset in question are likely to greatly influence the returns on using a greater proportion of the data. ([View Highlight](https://read.readwise.io/read/01hz5gsp9skmm0k1xk9aykcbdh))
- We evaluated several retrieval performance metrics at a range of thresholds on various benchmarks, sweeping across numerous hyperparameters to obtain the best performance possible. In doing so, we found that a couple patterns emerged: Binary cross-entropy was dominated by mean squared error, but triplet loss and mean squared error shone in different settings. For the linear adapters, 0.003 was frequently, though not always, the best choice of learning rate. The query-only linear adapter was consistently viable, which has exciting implications for personalized retrieval. ([View Highlight](https://read.readwise.io/read/01hz5h2j36ngnxsc080pnzevxr))
- The scalability of the query-only linear adapter opens up exciting possibilities for real-world applications. Given its computational efficiency, it would be feasible to deploy this approach in a live setting, where user-specific query adapters could be trained on-the-fly. We found in the data ablation section that the rate of improvement as a proportion of data can vary substantially, and we speculated that this is likely mediated by some notion of heterogeneity. Fortunately, the query-only linear adapter obviates the need to re-embed documents, making it possible to perform adaptation at a very granular level, even with a limited compute budget. By personalizing the retrieval process at the individual user level, we may be able to observe significant improvements in online metrics and user feedback. **This granular adaptation could potentially yield substantial gains, even with limited training data, due to the increased homogeneity within a single user's query distribution**. Implementing and evaluating this approach in a real-world scenario would provide valuable insights into the practical benefits of personalized retrieval-augmented generation. ([View Highlight](https://read.readwise.io/read/01hz5h3aeasrqbtmfgwjj41n6y))
- In addition to the query-only linear adapter, we also explored in our research the possibility of training a reranker to improve retrieval performance. While this approach has the potential to capture more complex relationships between queries and documents, our initial experiments yielded unstable results. We hypothesize that this instability may be due to the limited quantity of data available for training the reranker. As reranking models typically require a substantial amount of labeled data to learn effective ranking functions, the scarcity of data in our experiments likely hindered the reranker's performance. Future work could investigate the use of larger datasets or more data-efficient reranking algorithms to overcome this limitation. ([View Highlight](https://read.readwise.io/read/01hz5h3e4kpg2xqz7ze6nn45pg))
- Another avenue we briefly explored was the use of synthetic data to augment our training set. By generating synthetic documents to serve as positive examples for queries, we hoped to augment the data with positives in addition to the negative sampling. However, our initial attempts did not yield significant improvements in retrieval performance. This could be due to the challenges in generating realistic synthetic data that remains in-distribution for the dataset. Due to time constraints, we were unable to fully explore this approach, but we believe that further research into effective methods for generating and utilizing synthetic data could potentially enhance the adaptation process, particularly with the promising results by [Wang et al](https://arxiv.org/abs/2401.00368) on the use of synthetic data for improving embeddings. ([View Highlight](https://read.readwise.io/read/01hz5h3v8pwzy8gz6n4krqb0kj))
- To further enhance the expressiveness of the adaptation process, exploring neural network adapters could be a promising direction. By replacing the linear adapter with a more complex neural architecture, we may be able to capture more intricate patterns and relationships between user preferences and the retrieval process. This increased flexibility could potentially lead to better personalization and improved retrieval performance. In our experiments, we saw that the separate linear adapter for queries and documents performed relatively poorly in most settings we tested despite having the greatest representational capacity. As its representation space is a superset of that of all other linear adapters we trained, this underperformance points to a training or data issue, and we would be hesitant to write off this approach entirely based on these results. ([View Highlight](https://read.readwise.io/read/01hz5h44em6fe82d998vfke439))
- Therefore, it is important to consider the relationship between the adapter's representational capacity and the dataset size. Intuitively, a more expressive adapter, such as a neural network, would allow for a more fine-grained representation of user preferences, but it may also require more training data to effectively learn the parameters. On the other hand, in settings with limited data, decreasing the representational capacity by learning a rank-constrained weight matrix rather than a dense one, as in our linear adapters, would reduce the risk of overfitting. Conducting experiments to evaluate the interaction between representational capacity and dataset size could provide valuable insights into the optimal configuration for different scenarios. This spectrum of representational capacity offers a range of options to balance adapter expressivity with available data and computational resources. ([View Highlight](https://read.readwise.io/read/01hz5h4bmgcf0c9acgjpmv39js))
